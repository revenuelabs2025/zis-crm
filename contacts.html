<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM – Kontakty</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
  <style>
    /* (styl jak wcześniej – skrócony do kluczowych elementów) */
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f8f9fa;color:#111;min-height:100vh;display:flex}
    .sidebar{width:260px;background:#fff;border-right:1px solid #e5e7eb;position:fixed;inset:0 auto 0 0}
    .main{margin-left:260px;flex:1;display:flex;flex-direction:column}
    .header{background:#fff;border-bottom:1px solid #e5e7eb;padding:24px 32px}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .search{position:relative;flex:1;min-width:260px}
    .search input{width:100%;padding:10px 12px 10px 36px;border:1px solid #e5e7eb;border-radius:8px}
    .filter{padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    .btn{padding:10px 16px;border-radius:8px;border:none;background:#e58414;color:#fff;font-weight:600;cursor:pointer}
    .table-wrap{background:#fff;margin:24px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th{background:#fafbfc;color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.05em;text-align:left;padding:12px}
    td{padding:14px;border-top:1px solid #f3f4f6}
    .contact-name a{font-weight:700;color:#111;text-decoration:none}
    .owner-badge{display:inline-flex;gap:6px;align-items:center;background:#f3f4f6;border-radius:12px;padding:4px 10px}
    .empty{padding:48px;text-align:center;color:#6b7280}
    /* Modal + panel szczegółów */
    .modal,.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.show,.overlay.show{display:flex}
    .modal .content{background:#fff;border-radius:16px;width:90%;max-width:640px;max-height:90vh;overflow:auto;padding:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid.full{grid-template-columns:1fr}
    label{font-size:14px;font-weight:600;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .btn.secondary{background:#fff;color:#555;border:1px solid #e5e7eb}
    /* Panel boczny (quick view) */
    .drawer{position:fixed;top:0;right:-480px;width:480px;height:100vh;background:#fff;border-left:1px solid #e5e7eb;transition:right .25s;z-index:1100;display:flex;flex-direction:column}
    .drawer.show{right:0}
    .drawer header{padding:16px 20px;border-bottom:1px solid #e5e7eb}
    .drawer .body{padding:16px 20px;overflow:auto;flex:1}
    .section{margin-bottom:20px}
    .section h3{font-size:16px;margin-bottom:10px}
    .list{display:grid;gap:10px}
    .card{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fafbfc}
    .actions{display:flex;gap:8px;margin-bottom:12px}
    .muted{color:#6b7280;font-size:12px}
  </style>
</head>
<body>
  <!-- Sidebar skrócony -->
  <aside class="sidebar">
    <div style="padding:20px;border-bottom:1px solid #e5e7eb">
      <img src="http://dachplaski24.pl/wp-content/uploads/2025/08/LOGO-ZIS-ZAWADZKI.jpg" alt="ZIS" style="max-width:160px;display:block;margin:auto"/>
    </div>
    <div style="padding:16px;border-top:1px solid #e5e7eb">
      <div style="display:flex;gap:10px;align-items:center">
        <div id="userAvatar" style="display:none"></div>
        <div>
          <div id="userName" style="font-weight:700"></div>
          <div id="userEmail" style="font-size:12px;color:#6b7280"></div>
        </div>
      </div>
      <button class="btn secondary" style="width:100%;margin-top:12px" onclick="handleLogout()">Wyloguj</button>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <header class="header">
      <h1 style="margin-bottom:16px">Kontakty</h1>
      <div class="filters">
        <div class="search">
          <input id="searchInput" placeholder="Szukaj kontaktów..." oninput="applyFilters()"/>
          <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="#9ca3af"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
        <select id="fRegion" class="filter" onchange="applyFilters()"><option value="">Wszystkie województwa</option></select>
        <select id="fType" class="filter" onchange="applyFilters()"><option value="">Wszystkie typy</option></select>
        <select id="fOwner" class="filter" onchange="applyFilters()"><option value="">Wszyscy właściciele</option></select>
        <button class="btn" onclick="openContactModal()">Dodaj kontakt</button>
      </div>
    </header>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Kontakt</th>
            <th>Firma</th>
            <th>Adres</th>
            <th>Email</th>
            <th>Telefon</th>
            <th>Właściciel</th>
            <th>Ostatnia aktywność</th>
          </tr>
        </thead>
        <tbody id="contactsTbody"></tbody>
      </table>
      <div id="emptyState" class="empty" style="display:none">Brak kontaktów</div>
    </div>
  </div>

  <!-- Drawer Quick View -->
  <div class="drawer" id="drawer">
    <header>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="dvName" style="font-weight:800"></div>
          <div id="dvCompany" class="muted"></div>
        </div>
        <button class="btn secondary" onclick="closeDrawer()">Zamknij</button>
      </div>
    </header>
    <div class="body">
      <div class="section">
        <div class="actions">
          <button class="btn" onclick="openNoteModal()">Dodaj notatkę</button>
          <button class="btn" onclick="openTaskModal()">Dodaj zadanie</button>
          <button class="btn" onclick="openMessageModal()">Dodaj wiadomość</button>
        </div>
      </div>

      <div class="section">
        <h3>Notatki</h3>
        <div id="notesList" class="list"></div>
      </div>

      <div class="section">
        <h3>Zadania</h3>
        <div id="tasksList" class="list"></div>
      </div>

      <div class="section">
        <h3>Wiadomości</h3>
        <div id="messagesList" class="list"></div>
      </div>
    </div>
  </div>
  <div class="overlay" id="overlay" onclick="closeDrawer()"></div>

  <!-- Modal: Dodaj kontakt -->
  <div class="modal" id="contactModal">
    <div class="content">
      <h2>Dodaj kontakt</h2>
      <form id="contactForm" onsubmit="handleSaveContact(event)">
        <div class="grid">
          <div>
            <label>Imię i nazwisko *</label>
            <input id="c_full_name" required/>
          </div>
          <div>
            <label>Stanowisko</label>
            <input id="c_job_title" />
          </div>

          <div>
            <label>Firma *</label>
            <input id="c_company_name" required/>
          </div>
          <div>
            <label>Właściciel kontaktu *</label>
            <select id="c_owner_id" required><option value="">Wybierz właściciela</option></select>
          </div>

          <div class="full">
            <label>Ulica i numer</label>
            <input id="c_street_address" />
          </div>

          <div>
            <label>Miejscowość</label>
            <input id="c_city" />
          </div>
          <div>
            <label>Kod pocztowy</label>
            <input id="c_postal_code" />
          </div>

          <div>
            <label>Województwo *</label>
            <select id="c_region_id" required><option value="">Wybierz województwo</option></select>
          </div>
          <div>
            <label>Typ kontaktu *</label>
            <select id="c_contact_type_id" required><option value="">Wybierz typ</option></select>
          </div>

          <div>
            <label>Źródło pozyskania *</label>
            <select id="c_source_id" required><option value="">Wybierz źródło</option></select>
          </div>
          <div>
            <label>Email</label>
            <input id="c_email" type="email"/>
          </div>

          <div>
            <label>Telefon</label>
            <input id="c_phone" />
          </div>
        </div>
        <div class="row">
          <button type="button" class="btn secondary" onclick="closeContactModal()">Anuluj</button>
          <button type="submit" class="btn">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Notatka -->
  <div class="modal" id="noteModal">
    <div class="content">
      <h2>Dodaj notatkę</h2>
      <form id="noteForm" onsubmit="handleSaveNote(event)">
        <div class="grid full">
          <div>
            <label>Tytuł</label>
            <input id="n_title"/>
          </div>
          <div>
            <label>Treść *</label>
            <textarea id="n_content" rows="6" required></textarea>
          </div>
          <div>
            <label>Link</label>
            <input id="n_link" />
          </div>
        </div>
        <div class="row">
          <button type="button" class="btn secondary" onclick="closeNoteModal()">Anuluj</button>
          <button type="submit" class="btn">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Zadanie -->
  <div class="modal" id="taskModal">
    <div class="content">
      <h2>Dodaj zadanie</h2>
      <form id="taskForm" onsubmit="handleSaveTask(event)">
        <div class="grid">
          <div class="full">
            <label>Nazwa zadania *</label>
            <input id="t_title" required/>
          </div>
          <div class="full">
            <label>Opis</label>
            <textarea id="t_description" rows="4"></textarea>
          </div>
          <div>
            <label>Termin wykonania</label>
            <input id="t_due_at" type="datetime-local"/>
          </div>
        </div>
        <div class="row">
          <button type="button" class="btn secondary" onclick="closeTaskModal()">Anuluj</button>
          <button type="submit" class="btn">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Wiadomość -->
  <div class="modal" id="messageModal">
    <div class="content">
      <h2>Dodaj wiadomość</h2>
      <form id="messageForm" onsubmit="handleSaveMessage(event)">
        <div class="grid">
          <div class="full">
            <label>Temat *</label>
            <input id="m_subject" required/>
          </div>
          <div>
            <label>Rodzaj *</label>
            <select id="m_type" required>
              <option value="">Wybierz</option>
              <option value="email">Email</option>
              <option value="sms">SMS</option>
              <option value="call">Rozmowa tel.</option>
            </select>
          </div>
          <div>
            <label>Podgląd</label>
            <input id="m_preview"/>
          </div>
          <div class="full">
            <label>Treść pierwszej wiadomości *</label>
            <textarea id="m_body" rows="6" required></textarea>
          </div>
        </div>
        <div class="row">
          <button type="button" class="btn secondary" onclick="closeMessageModal()">Anuluj</button>
          <button type="submit" class="btn">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- Supabase init ---
    const SUPABASE_URL = 'https://atbldtbvrmgoisykmizn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0YmxkdGJ2cm1nb2lzeWttaXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTk0MDIsImV4cCI6MjA3MTY5NTQwMn0.xyC0Osw4u--L3kdCF76ih1CSLFA16FKyz9I9PNt33zI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Auth / bieżący użytkownik ---
    let currentUser = null;
    let currentProfile = null; // profiles row of current user

    // --- Referencje (cache do mapowania nazw) ---
    let regions = [];
    let contactTypes = [];
    let owners = [];  // profiles
    let sources = [];

    // Mapy szybkie
    const rMap = new Map(), ctMap = new Map(), oMap = new Map(), sMap = new Map();

    // --- Dane kontaktów (z bazy) + widok po filtrze ---
    let contacts = [];
    let filtered = [];

    // --- Kontekst wybranego kontaktu w panelu ---
    let activeContact = null;

    // ======= Narzędzia =======
    const norm = s => (s ?? '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const formatDateHuman = iso => {
      if (!iso) return '—';
      const d = new Date(iso);
      const now = new Date();
      const diff = (now - d) / (1000*60*60*24);
      if (diff < 1) return 'Dzisiaj';
      if (diff < 2) return 'Wczoraj';
      if (diff < 7) return `${Math.floor(diff)} dni temu`;
      return d.toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit',year:'numeric'});
    };

    // ======= UI: Modale / Drawer =======
    const $ = sel => document.querySelector(sel);

    function openContactModal(){ $('#contactForm').reset(); fillContactModalSelects(); $('#contactModal').classList.add('show'); }
    function closeContactModal(){ $('#contactModal').classList.remove('show'); }

    function openNoteModal(){ if(!activeContact) return; $('#noteForm').reset(); $('#noteModal').classList.add('show'); }
    function closeNoteModal(){ $('#noteModal').classList.remove('show'); }

    function openTaskModal(){ if(!activeContact) return; $('#taskForm').reset(); $('#taskModal').classList.add('show'); }
    function closeTaskModal(){ $('#taskModal').classList.remove('show'); }

    function openMessageModal(){ if(!activeContact) return; $('#messageForm').reset(); $('#messageModal').classList.add('show'); }
    function closeMessageModal(){ $('#messageModal').classList.remove('show'); }

    function openDrawer(contact){
      activeContact = contact;
      $('#dvName').textContent = contact.full_name || `${contact.first_name||''} ${contact.last_name||''}`.trim();
      $('#dvCompany').textContent = contact.company_name || '—';
      $('#drawer').classList.add('show');
      $('#overlay').classList.add('show');
      loadNotes(contact.id);
      loadTasks(contact.id);
      loadMessages(contact.id);
    }
    function closeDrawer(){
      activeContact = null;
      $('#drawer').classList.remove('show');
      $('#overlay').classList.remove('show');
    }

    // ======= Ładowanie referencji i filtrów =======
    async function loadRefs(){
      const [r, ct, o, s] = await Promise.all([
        supabaseClient.from('regions').select('id,name').order('name'),
        supabaseClient.from('contact_types').select('id,name').order('name'),
        supabaseClient.from('profiles').select('id,full_name').order('full_name'),
        supabaseClient.from('sources').select('id,name').order('name'),
      ]);
      regions = r.data||[]; contactTypes = ct.data||[]; owners = (o.data||[]).filter(x=>x.full_name); sources = s.data||[];
      rMap.clear(); regions.forEach(x=>rMap.set(x.id,x.name));
      ctMap.clear(); contactTypes.forEach(x=>ctMap.set(x.id,x.name));
      oMap.clear(); owners.forEach(x=>oMap.set(x.id,x.full_name));
      sMap.clear(); sources.forEach(x=>sMap.set(x.id,x.name));

      // filtry
      const fRegion = $('#fRegion'), fType = $('#fType'), fOwner = $('#fOwner');
      fRegion.innerHTML = '<option value="">Wszystkie województwa</option>';
      regions.forEach(r => fRegion.appendChild(new Option(r.name, r.id)));
      fType.innerHTML = '<option value="">Wszystkie typy</option>';
      contactTypes.forEach(t => fType.appendChild(new Option(t.name, t.id)));
      fOwner.innerHTML = '<option value="">Wszyscy właściciele</option>';
      owners.forEach(o => fOwner.appendChild(new Option(o.full_name, o.id)));
    }

    function fillContactModalSelects(){
      // selecty w modalu kontaktu
      const sel = (id) => document.getElementById(id);
      const regionSel = sel('c_region_id'), typeSel = sel('c_contact_type_id'), ownerSel = sel('c_owner_id'), sourceSel = sel('c_source_id');
      regionSel.innerHTML = '<option value="">Wybierz województwo</option>';
      regions.forEach(r => regionSel.appendChild(new Option(r.name, r.id)));
      typeSel.innerHTML = '<option value="">Wybierz typ</option>';
      contactTypes.forEach(t => typeSel.appendChild(new Option(t.name, t.id)));
      ownerSel.innerHTML = '<option value="">Wybierz właściciela</option>';
      owners.forEach(o => ownerSel.appendChild(new Option(o.full_name, o.id)));
      sourceSel.innerHTML = '<option value="">Wybierz źródło</option>';
      sources.forEach(s => sourceSel.appendChild(new Option(s.name, s.id)));
    }

    // ======= Kontakty: pobieranie, render, filtry =======
    async function loadContacts(){
      const { data, error } = await supabaseClient
        .from('contacts')
        .select('id, first_name, last_name, full_name, job_title, company_name, street_address, city, postal_code, region_id, email, phone, owner_id, contact_type_id, source_id, last_activity_at, created_at')
        .order('created_at', { ascending: false });

      if (error){ console.error(error); return; }
      contacts = data || [];
      filtered = [...contacts];
      renderContacts();
      applyFilters(); // od razu filtr po pustych selektach
    }

    function applyFilters(){
      const q = norm($('#searchInput').value);
      const fr = $('#fRegion').value;
      const ft = $('#fType').value;
      const fo = $('#fOwner').value;

      filtered = contacts.filter(c => {
        const matchesQ = !q ||
          norm(c.full_name || `${c.first_name||''} ${c.last_name||''}`).includes(q) ||
          norm(c.company_name).includes(q) ||
          norm(c.email).includes(q) ||
          (c.phone||'').includes(q);

        const matchesR = !fr || c.region_id === fr;
        const matchesT = !ft || c.contact_type_id === ft;
        const matchesO = !fo || c.owner_id === fo;

        return matchesQ && matchesR && matchesT && matchesO;
      });
      renderContacts();
    }

    function renderContacts(){
      const tbody = $('#contactsTbody');
      const empty = $('#emptyState');

      if (!filtered.length){
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = filtered.map(c => {
        const name = c.full_name || `${c.first_name||''} ${c.last_name||''}`.trim();
        const company = c.company_name || '—';
        const address = [c.street_address, c.postal_code, c.city].filter(Boolean).join(', ');
        const email = c.email || '—';
        const phone = c.phone || '—';
        const ownerName = oMap.get(c.owner_id) || '—';
        const lastAct = formatDateHuman(c.last_activity_at);

        const link = `/contact-details?id=${encodeURIComponent(c.id)}`;

        return `
          <tr onclick="openDrawerById('${c.id}')">
            <td class="contact-name">
              <a href="${link}" onclick="event.stopPropagation()">${name}</a>
              ${c.job_title ? `<div class="muted">${c.job_title}</div>` : ''}
            </td>
            <td>${company}</td>
            <td>${address || '—'}</td>
            <td>${email !== '—' ? `<a href="mailto:${email}" onclick="event.stopPropagation()">${email}</a>` : '—'}</td>
            <td>${phone !== '—' ? `<a href="tel:${phone}" onclick="event.stopPropagation()">${phone}</a>` : '—'}</td>
            <td><span class="owner-badge"><span style="width:8px;height:8px;border-radius:50%;background:#10b981"></span>${ownerName}</span></td>
            <td>${lastAct}</td>
          </tr>
        `;
      }).join('');
    }

    function openDrawerById(id){
      const c = contacts.find(x=>x.id===id);
      if (c) openDrawer(c);
    }

    // ======= Zapis kontaktu =======
    function splitName(full){
      const parts = (full||'').trim().split(/\s+/);
      if (parts.length === 0) return { first_name: '', last_name: '' };
      if (parts.length === 1) return { first_name: parts[0], last_name: '' };
      const last_name = parts.pop();
      return { first_name: parts.join(' '), last_name };
    }

    async function handleSaveContact(e){
      e.preventDefault();
      const full_name = $('#c_full_name').value.trim();
      const { first_name, last_name } = splitName(full_name);

      const payload = {
        first_name,
        last_name,
        full_name,
        job_title: $('#c_job_title').value.trim() || null,
        company_name: $('#c_company_name').value.trim(),
        street_address: $('#c_street_address').value.trim() || null,
        city: $('#c_city').value.trim() || null,
        postal_code: $('#c_postal_code').value.trim() || null,
        region_id: $('#c_region_id').value,
        email: $('#c_email').value.trim() || null,
        phone: $('#c_phone').value.trim() || null,
        owner_id: $('#c_owner_id').value,
        contact_type_id: $('#c_contact_type_id').value,
        source_id: $('#c_source_id').value,
        // updated_at/created_at ustawi DB; last_activity_at zostawiamy null
      };

      const { data, error } = await supabaseClient.from('contacts').insert(payload).select('id').single();
      if (error){ alert('Błąd zapisu kontaktu'); console.error(error); return; }

      closeContactModal();
      await loadContacts();
    }

    // ======= Notatki / Zadania / Wiadomości – odczyt =======
    async function loadNotes(contact_id){
      const { data, error } = await supabaseClient
        .from('contact_notes')
        .select('id,title,content,link,pinned,author_id,created_at,updated_at')
        .eq('contact_id', contact_id)
        .order('created_at', { ascending:false });
      if (error){ console.error(error); return; }

      const el = $('#notesList');
      el.innerHTML = (data||[]).map(n => `
        <div class="card">
          <div style="font-weight:700">${n.title||'Notatka'}</div>
          <div class="muted" style="margin:4px 0">${new Date(n.created_at).toLocaleString('pl-PL')}</div>
          <div>${(n.content||'').replace(/\n/g,'<br/>')}</div>
          ${n.link ? `<div class="muted" style="margin-top:6px"><a href="${n.link}" target="_blank">Link</a></div>`:''}
        </div>
      `).join('') || '<div class="muted">Brak notatek</div>';
    }

    async function loadTasks(contact_id){
      const { data, error } = await supabaseClient
        .from('contact_tasks')
        .select('id,title,description,owner_id,due_at,completed_at,created_at')
        .eq('contact_id', contact_id)
        .order('created_at', { ascending:false });
      if (error){ console.error(error); return; }

      const el = $('#tasksList');
      el.innerHTML = (data||[]).map(t => {
        const ownerName = oMap.get(t.owner_id)||'—';
        const status = t.completed_at ? `Zakończono: ${new Date(t.completed_at).toLocaleString('pl-PL')}` :
          (t.due_at ? `Termin: ${new Date(t.due_at).toLocaleString('pl-PL')}` : 'Otwarte');
        return `
          <div class="card">
            <div style="font-weight:700">${t.title}</div>
            <div class="muted" style="margin:4px 0">${status} • Właściciel: ${ownerName}</div>
            ${t.description ? `<div>${t.description}</div>`:''}
          </div>
        `;
      }).join('') || '<div class="muted">Brak zadań</div>';
    }

    async function loadMessages(contact_id){
      const { data, error } = await supabaseClient
        .from('contact_messages')
        .select('id,subject,message_type,preview,last_message_at,created_at,updated_at')
        .eq('contact_id', contact_id)
        .order('last_message_at', { ascending:false })
        .order('created_at', { ascending:false });
      if (error){ console.error(error); return; }

      const el = $('#messagesList');
      el.innerHTML = (data||[]).map(m => `
        <div class="card">
          <div style="font-weight:700">${m.subject||'(bez tematu)'} <span class="muted">[${m.message_type}]</span></div>
          <div class="muted" style="margin:4px 0">Ostatnia wiadomość: ${formatDateHuman(m.last_message_at||m.created_at)}</div>
          <div>${m.preview||''}</div>
        </div>
      `).join('') || '<div class="muted">Brak wiadomości</div>';
    }

    async function bumpLastActivity(contact_id){
      await supabaseClient.from('contacts').update({ last_activity_at: new Date().toISOString() }).eq('id', contact_id);
    }

    // ======= Notatki / Zadania / Wiadomości – zapis =======
    async function handleSaveNote(e){
      e.preventDefault();
      if (!activeContact || !currentUser) return;
      const payload = {
        contact_id: activeContact.id,
        author_id: currentUser.id,
        title: $('#n_title').value.trim() || null,
        content: $('#n_content').value,
        link: $('#n_link').value.trim() || null,
        pinned: false
      };
      const { error } = await supabaseClient.from('contact_notes').insert(payload);
      if (error){ alert('Błąd zapisu notatki'); console.error(error); return; }
      await bumpLastActivity(activeContact.id);
      closeNoteModal();
      await loadNotes(activeContact.id);
      await loadContacts(); // odśwież listę (ostatnia aktywność)
    }

    async function handleSaveTask(e){
      e.preventDefault();
      if (!activeContact || !currentUser) return;
      const due = $('#t_due_at').value ? new Date($('#t_due_at').value).toISOString() : null;
      const payload = {
        contact_id: activeContact.id,
        owner_id: currentUser.id, // przypisanie do bieżącego użytkownika
        title: $('#t_title').value,
        description: $('#t_description').value.trim() || null,
        due_at: due,
        completed_at: null
      };
      const { error } = await supabaseClient.from('contact_tasks').insert(payload);
      if (error){ alert('Błąd zapisu zadania'); console.error(error); return; }
      await bumpLastActivity(activeContact.id);
      closeTaskModal();
      await loadTasks(activeContact.id);
      await loadContacts();
    }

    async function handleSaveMessage(e){
      e.preventDefault();
      if (!activeContact || !currentUser) return;

      const subject = $('#m_subject').value.trim();
      const message_type = $('#m_type').value;
      const preview = $('#m_preview').value.trim() || null;
      const body = $('#m_body').value;

      // 1) Tworzymy wątek/konwersację contact_messages
      const nowIso = new Date().toISOString();
      const { data: msg, error: e1 } = await supabaseClient
        .from('contact_messages')
        .insert({
          contact_id: activeContact.id,
          subject,
          message_type,
          preview,
          last_message_at: nowIso
        })
        .select('id')
        .single();
      if (e1){ alert('Błąd zapisu wiadomości (nagłówek)'); console.error(e1); return; }

      // 2) Dodajemy pierwszą wiadomość do message_threads
      const { error: e2 } = await supabaseClient
        .from('message_threads')
        .insert({
          message_id: msg.id,
          author_id: currentUser.id,
          body,
          sent_at: nowIso
        });
      if (e2){ alert('Błąd zapisu treści wiadomości'); console.error(e2); return; }

      await bumpLastActivity(activeContact.id);
      closeMessageModal();
      await loadMessages(activeContact.id);
      await loadContacts();
    }

    // ======= Auth + boot =======
    async function boot(){
      // user info
      try{
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentUser = session?.user ?? null;
        if (!currentUser){
          const { data } = await supabaseClient.auth.getUser();
          currentUser = data?.user ?? null;
        }
      }catch(e){ console.warn('auth error', e); }

      if (!currentUser?.id){
        // przekieruj do logowania, jeśli trzeba
        // window.location.href = 'index.html';
        console.warn('Brak sesji — część operacji może się nie udać (RLS)');
      }

      // sidebar dane użytkownika
      try{
        const { data } = await supabaseClient.from('profiles').select('full_name').eq('id', currentUser.id).single();
        currentProfile = data || null;
        document.getElementById('userName').textContent = currentProfile?.full_name || currentUser?.email || '';
        document.getElementById('userEmail').textContent = currentUser?.email || '';
        const av = document.getElementById('userAvatar'); if (av) av.remove(); // bez avatara
      }catch(e){ /* no-op */ }

      await loadRefs();
      await loadContacts();
    }

    function handleLogout(){
      supabaseClient.auth.signOut().finally(()=>location.href='index.html');
    }

    // start
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
